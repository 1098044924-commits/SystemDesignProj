#cloud-config
package_update: true
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - wget
  - gnupg
  - lsb-release

write_files:
  - path: /etc/accounting/accounting.env
    content: |
      JDBC_DATABASE_URL=${JDBC_DATABASE_URL:-jdbc:h2:mem:accounting;DB_CLOSE_DELAY=-1}
      JDBC_DATABASE_USERNAME=${JDBC_DATABASE_USERNAME:-sa}
      JDBC_DATABASE_PASSWORD=${JDBC_DATABASE_PASSWORD:-}
      JDBC_DATABASE_DRIVER=${JDBC_DATABASE_DRIVER:-org.h2.Driver}
      JPA_HBM2DDL=${JPA_HBM2DDL:-update}
      SPRING_PORT=${SPRING_PORT:-8080}
      JAVA_OPTS="${JAVA_OPTS:- -Xms512m -Xmx1g}"
      JAR_URL="${JAR_URL:-}"
      JAR_FILE="${JAR_FILE:-SystemDesignProj-1.0-SNAPSHOT.jar}"
    owner: root:root
    permissions: '0644'

runcmd:
  - [ bash, -lc, |
      set -e
      # create user if not exists
      if ! id -u accounting >/dev/null 2>&1; then
        useradd -m -s /bin/bash -U accounting
      fi
      mkdir -p /opt/accounting
      chown accounting:accounting /opt/accounting

      # install OpenJDK 17 and maven if absent
      if ! command -v java >/dev/null 2>&1 || ! java -version 2>&1 | grep "17" >/dev/null 2>&1; then
        apt-get update
        apt-get install -y openjdk-17-jdk maven
      fi

      # source env
      source /etc/accounting/accounting.env

      # download jar if JAR_URL provided and file absent
      if [ -n "$JAR_URL" ] && [ ! -f "/opt/accounting/$JAR_FILE" ]; then
        wget -O "/opt/accounting/$JAR_FILE" "$JAR_URL"
        chown accounting:accounting "/opt/accounting/$JAR_FILE"
      fi

      # write systemd unit
      cat > /etc/systemd/system/accounting.service <<'SERVICE'
[Unit]
Description=Accounting App
After=network.target

[Service]
Type=simple
User=accounting
Group=accounting
EnvironmentFile=/etc/accounting/accounting.env
WorkingDirectory=/opt/accounting
ExecStart=/usr/bin/java $JAVA_OPTS -jar /opt/accounting/${JAR_FILE}
Restart=on-failure
RestartSec=5s
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
SERVICE

      systemctl daemon-reload
      systemctl enable accounting

      # start only if jar present
      if [ -f "/opt/accounting/$JAR_FILE" ]; then
        systemctl restart accounting
      else
        echo "JAR not found at /opt/accounting/$JAR_FILE. Upload JAR or set JAR_URL and rerun." > /opt/accounting/STARTUP_NOTES.txt
      fi
    ]



